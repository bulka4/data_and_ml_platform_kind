apiVersion: apps/v1
kind: Deployment
metadata:
  name: hive-metastore
  namespace: {{ .Values.namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hive-metastore
  template:
    metadata:
      labels:
        app: hive-metastore
    spec:
      # Get a secret with credentials for authentication to the ACR.
      # imagePullSecrets:
      #   - name: {{ .Values.acrSecret.secretName }}
      initContainers:
        - name: prepare-configs
          image: alpine:latest
          command:
            - sh
            - -c
            - |              
              # Install envsubst
              apk add --no-cache gettext

              # Interpolate template config files (insert values of env vars)
              envsubst < /opt/hive/conf/template/hive-site.xml.template > /opt/hive/conf/hive-site.xml
              envsubst < /opt/hive/conf/template/core-site.xml.template > /opt/hive/conf/core-site.xml
          volumeMounts:
            - name: hive-conf-template
              mountPath: /opt/hive/conf/template
            - name: hive-conf
              mountPath: /opt/hive/conf
            - name: tmp-volume
              mountPath: /tmp/hive
          env:
            # Password to the PostgreSQL metadata db from the secret. It is used in the hive-site.xml created in the configMap
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgresql.secret.name }}
                  key: {{ .Values.postgresql.secret.userPasswordKey }}
            - name: STORAGE_ACCOUNT
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.hive.storageAccount.secret }}
                  key: storage-account
            - name: SA_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.hive.storageAccount.secret }}
                  key: sa-access-key
            - name: CONTAINER
              value: {{ .Values.hive.storageAccount.container }}
      containers:
        - name: hive-metastore
          image: "{{ .Values.hive.image.url }}"
          imagePullPolicy: {{ .Values.hive.image.pullPolicy }}
          # command: ["sh", "-c", "sleep 3600"]
          ports:
            - containerPort: {{ .Values.hive.metastorePort }}
          env:
            # Limit heap size (how much memory JAVA processes can take). If this limit is exceeded then JAVA process gets killed,
            # not the entire pod
            - name: HADOOP_HEAPSIZE
              value: "2048" # MB
            - name: HIVE_HEAPSIZE
              value: "2048" # MB
            # Indicate to use PostgreSQL as metadata db
            - name: DB_DRIVER
              value: postgres
            # Run only Metastore
            - name: SERVICE_NAME
              value: metastore
          # Mount the config files created in the ConfigMap
          volumeMounts:
            - name: hive-conf
              mountPath: /opt/hive/conf
            - name: tmp-volume
              mountPath: /tmp/hive
          resources:
            requests:
              memory: {{ .Values.hive.resources.requests.memory }}
              cpu: {{ .Values.hive.resources.requests.cpu }}
            limits:
              memory: {{ .Values.hive.resources.limits.memory }}
              cpu: {{ .Values.hive.resources.limits.cpu }}
      volumes:
        - name: hive-conf-template
          configMap:
            name: hive-conf-template
        - name: tmp-volume
          emptyDir: {}
        - name: hive-conf
          emptyDir: {}